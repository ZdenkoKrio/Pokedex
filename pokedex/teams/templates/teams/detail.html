{% extends "base.html" %}

{% load static %}
{% load dict_extras %}

{% block title %}{{ team.name }}{% endblock %}

{% block extra_css %}
  <link rel="stylesheet" href="{% static 'css/team-detail.css' %}">
{% endblock %}

{% block content %}
  <!-- Header -->
  <div class="team-header">
    <div>
      <h1 style="margin:0;">{{ team.name }}</h1>
      <div class="team-meta">
        Owner: <b>{{ team.owner.username }}</b>
        {% if not team.is_public %} · <span class="chip">Private</span>{% else %} · <span class="chip">Public</span>{% endif %}
        · Updated: {{ team.updated_at|date:"Y-m-d" }}
      </div>
      <p style="margin:.5rem 0 0;">{{ team.description|default:"—" }}</p>
    </div>
    {% if request.user == team.owner %}
      <div style="display:flex; gap:8px; flex-wrap:wrap;">
        <a class="btn-secondary" href="{% url 'teams:edit' team.pk %}">Edit</a>
        <a class="btn-secondary" href="{% url 'teams:delete' team.pk %}">Delete</a>
      </div>
    {% endif %}
  </div>
<div class="team-meta">
  Owner: <b>{{ team.owner.username }}</b>
  {% if not team.is_public %} · <span class="chip">Private</span>{% else %} · <span class="chip">Public</span>{% endif %}
  · Updated: {{ team.updated_at|date:"Y-m-d" }}
</div>

<div style="margin-top:8px; display:flex; gap:8px; flex-wrap:wrap;">
  {% if request.user == team.owner %}
    <a class="btn-secondary" href="{% url 'teams:edit' team.pk %}">Edit</a>
    <a class="btn-secondary" href="{% url 'teams:delete' team.pk %}">Delete</a>
  {% endif %}

  {% if user.is_authenticated %}
    <button
      class="like-btn js-like {% if team.is_liked %}is-active{% endif %}"
      data-like-url="{% url 'community:team_like_toggle' team.id %}">
      👍 <span class="cnt">{{ team.likes_count|default:0 }}</span>
    </button>
  {% else %}
    <a class="like-btn" href="{% url 'accounts:login' %}?next={{ request.get_full_path|urlencode }}">
      👍 <span class="cnt">{{ team.likes_count|default:0 }}</span>
    </a>
  {% endif %}
</div>

  {% if not members %}
    <p>Empty team.</p>
  {% else %}

    <!-- Radar chart -->
    <h2 class="section-title">Team radar chart</h2>
    <canvas id="teamChart" width="900" height="420"></canvas>

    <!-- Members -->
    <h2 class="section-title">Members</h2>
    <div class="members-grid">
      {% for m in members %}
        <div class="card" style="padding:12px;">
          <a class="card-link" href="{% url 'pokemon:pokemon_detail' m.id %}" aria-label="{{ m.name|title }}">
            <div style="display:flex; align-items:center; gap:12px; margin-bottom:10px;">
              <img src="{{ m.sprite }}" alt="{{ m.name }}" loading="lazy" style="width:64px;height:64px;image-rendering:pixelated;">
              <div>
                <div class="pname" style="font-weight:700;">#{{ m.id }} · {{ m.name|title }}</div>
              </div>
            </div>
          </a>

          {% if m.stats %}
            <div style="display:grid; gap:6px;">
              {% for k in stats_keys %}
                {% with val=m.stats|get:k|default:0 %}
                  <div class="stat-row">
                    <div class="stat-name">{{ k|upper }}</div>
                    <div class="stat-bar" style="--val: {{ val|floatformat:0 }};"></div>
                    <div class="stat-num">{{ val }}</div>
                  </div>
                {% endwith %}
              {% endfor %}
              {# BST sum #}
              {% with total=0 %}
                {% for k in stats_keys %}
                  {% with v=m.stats|get:k|default:0 %}
                    {% with total=total|add:v %}{% endwith %}
                  {% endwith %}
                {% endfor %}
                <div class="stat-row" style="margin-top:4px;">
                  <div class="stat-name"><b>SUM</b></div>
                  <div class="stat-bar" style="--val: {{ total|floatformat:0 }};"></div>
                  <div class="stat-num"><b>{{ total }}</b></div>
                </div>
              {% endwith %}
            </div>
          {% else %}
            <p style="color:#6b7280;">No stats available.</p>
          {% endif %}
        </div>
      {% endfor %}
    </div>

    {# JSON payload pre JS #}
    {{ members|json_script:"team-members" }}
    {{ stats_keys|json_script:"team-stats-keys" }}
  {% endif %}

{# --- Comments --- #}
<h2 class="section-title">Comments</h2>

{% if user.is_authenticated %}
  <form id="comment-form" class="comment-form" data-post-url="{% url 'community:comment_create' team.id %}">
    {% csrf_token %}
    <textarea id="comment-body" name="body" rows="3" placeholder="Write a comment..." required></textarea>
    <div style="margin-top:6px;">
      <button class="btn-primary" type="submit">Post</button>
    </div>
  </form>
{% else %}
  <p><a href="{% url 'accounts:login' %}?next={{ request.get_full_path|urlencode }}">Log in</a> to comment.</p>
{% endif %}

{% comment %} team detail - comments block {% endcomment %}
<ul id="comment-list" class="comment-list">
  {% for c in comments %}
    <li data-id="{{ c.id }}">
      <div class="c-head">
        <a href="{% url 'community:user_detail' c.author_id %}">@{{ c.author.username }}</a>
        <span class="when">{{ c.created_at|date:"Y-m-d H:i" }}</span>
        {% if perms.community.can_moderate_comments %}
          <button class="c-del js-del" data-del-url="{% url 'community:comment_delete' c.id %}">Delete</button>
        {% endif %}
      </div>
      <div class="c-body">{{ c.body|linebreaksbr }}</div>
    </li>
  {% empty %}
    <li class="empty">No comments yet.</li>
  {% endfor %}
</ul>
{% endblock %}

{% block extra_js %}
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script type="module" src="{% static 'js/team-detail.js' %}"></script>
 <script type="module" src="{% static 'js/comments.js' %}"></script>
 <script type="module" src="{% static 'js/likes.js' %}"></script>
{% endblock %}